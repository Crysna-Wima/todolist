<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KOPERINDO - Project Management</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2c3e50;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --sidebar-width: 260px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      overflow-x: hidden;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--secondary);
      color: white;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: bold;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 5px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 10px;
    }

    .menu-item {
      padding: 12px 15px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(255,255,255,0.8);
    }

    .menu-item:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .menu-item.active {
      background: var(--primary);
      color: white;
    }

    .menu-item i {
      width: 20px;
      text-align: center;
    }

    .menu-section-title {
      padding: 20px 15px 10px;
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      font-weight: 600;
    }

    .project-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .project-item {
      padding: 10px 15px;
      margin: 3px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      color: rgba(255,255,255,0.8);
    }

    .project-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .project-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .project-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ========== MAIN CONTENT ========== */
    .main-wrapper {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s;
    }

    .main-wrapper.expanded {
      margin-left: 70px;
    }

    .top-navbar {
      background: white;
      border-bottom: 1px solid #e1e8ed;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }

    .breadcrumb {
      display: flex;
      gap: 8px;
      font-size: 14px;
      color: #7f8c8d;
      margin: 0;
      background: none;
      padding: 0;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      padding: 8px 35px 8px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      width: 250px;
      transition: all 0.3s;
    }

    .search-box input:focus {
      width: 350px;
      outline: none;
      border-color: var(--primary);
    }

    .search-box i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #95a5a6;
    }

    .notification-bell {
      position: relative;
      cursor: pointer;
      padding: 8px;
    }

    .notification-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--danger);
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: bold;
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
    }

    .content-area {
      padding: 30px;
      min-height: calc(100vh - 70px);
    }

    /* ========== DASHBOARD STATS ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }

    .stat-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-title {
      font-size: 13px;
      text-transform: uppercase;
      color: #7f8c8d;
      font-weight: 600;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-trend {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }

    /* ========== TASK BOARD (KANBAN) ========== */
    .board-container {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 20px;
    }

    .board-column {
      min-width: 300px;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }

    .column-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-count-badge {
      background: #6c757d;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .task-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .task-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .task-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .task-priority {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-urgent {
      background: #fee;
      color: #c0392b;
    }

    .priority-high {
      background: #fef5e7;
      color: #d68910;
    }

    .priority-medium {
      background: #e8f8f5;
      color: #16a085;
    }

    .priority-low {
      background: #f4f6f7;
      color: #7f8c8d;
    }

    .task-title {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.4;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 10px;
    }

    .task-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-assignees {
      display: flex;
      margin-top: 10px;
    }

    .assignee-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid white;
      margin-left: -8px;
    }

    .assignee-avatar:first-child {
      margin-left: 0;
    }

    .task-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .task-tag {
      background: #ecf0f1;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    /* ========== LIST VIEW ========== */
    .table-wrapper {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .table-filters {
      padding: 20px;
      border-bottom: 1px solid #e1e8ed;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    /* ========== MODALS ========== */
    .modal-header {
      border-bottom: 1px solid #e1e8ed;
      padding: 20px 25px;
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      border-top: 1px solid #e1e8ed;
      padding: 15px 25px;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px 15px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
    }

    /* ========== BUTTONS ========== */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* ========== UTILITIES ========== */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 50px;
      font-size: 24px;
      color: var(--primary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    /* ========== SCROLLBAR ========== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #bdc3c7;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #95a5a6;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .main-wrapper {
        margin-left: 0;
      }

      .search-box input {
        width: 150px;
      }

      .search-box input:focus {
        width: 200px;
      }
    }

    /* ========== CALENDAR VIEW ========== */
    .calendar-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-nav {
      display: flex;
      gap: 10px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e1e8ed;
      border: 1px solid #e1e8ed;
    }

    .calendar-day-header {
      background: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }

    .calendar-day {
      background: white;
      min-height: 100px;
      padding: 8px;
    }

    .calendar-day-number {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .calendar-task {
      background: var(--primary);
      color: white;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 11px;
      margin-bottom: 3px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ========== COMMENTS ========== */
    .comments-section {
      margin-top: 20px;
      border-top: 1px solid #e1e8ed;
      padding-top: 20px;
    }

    .comment-item {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
    }

    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }

    .comment-content {
      flex: 1;
    }

    .comment-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 5px;
    }

    .comment-author {
      font-weight: 600;
      font-size: 14px;
    }

    .comment-time {
      font-size: 12px;
      color: #7f8c8d;
    }

    .comment-text {
      font-size: 14px;
      line-height: 1.5;
    }

    /* ========== TIME TRACKER ========== */
    .time-tracker {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .timer-display {
      font-size: 24px;
      font-weight: bold;
      font-family: monospace;
      color: var(--primary);
    }

    .timer-controls {
      display: flex;
      gap: 10px;
    }

    /* ========== GANTT CHART ========== */
    .gantt-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      overflow-x: auto;
    }

    .gantt-timeline {
      display: flex;
      min-width: 1200px;
    }

    .gantt-tasks {
      width: 250px;
      border-right: 1px solid #e1e8ed;
    }

    .gantt-bars {
      flex: 1;
      position: relative;
    }

    .gantt-task-row {
      height: 40px;
      border-bottom: 1px solid #f8f9fa;
      display: flex;
      align-items: center;
      padding: 0 10px;
    }

    .gantt-bar {
      height: 24px;
      background: var(--primary);
      border-radius: 4px;
      position: absolute;
      top: 8px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fas fa-rocket"></i>
        <span>KOPERINDO</span>
      </div>
      <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <ul class="sidebar-menu">
      <li class="menu-item active" data-view="dashboard">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
      </li>
      <li class="menu-item" data-view="board">
        <i class="fas fa-columns"></i>
        <span>Board</span>
      </li>
      <li class="menu-item" data-view="list">
        <i class="fas fa-list"></i>
        <span>List</span>
      </li>
      <li class="menu-item" data-view="calendar">
        <i class="fas fa-calendar-alt"></i>
        <span>Calendar</span>
      </li>
      <li class="menu-item" data-view="gantt">
        <i class="fas fa-chart-bar"></i>
        <span>Timeline</span>
      </li>
      <li class="menu-item" data-view="team">
        <i class="fas fa-users"></i>
        <span>Team</span>
      </li>
      <li class="menu-item" data-view="reports">
        <i class="fas fa-chart-pie"></i>
        <span>Reports</span>
      </li>
    </ul>

    <div class="menu-section-title">PROJECTS</div>
    <div class="project-list" id="projectList">
      <!-- Projects will be loaded here -->
    </div>
    
    <div style="padding: 10px;">
      <button class="btn btn-primary btn-sm w-100" onclick="openProjectModal()">
        <i class="fas fa-plus"></i> New Project
      </button>
    </div>

    <ul class="sidebar-menu" style="margin-top: 20px;">
      <li class="menu-item" data-view="settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-wrapper" id="mainWrapper">
    <!-- Top Navbar -->
    <nav class="top-navbar">
      <div class="navbar-left">
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
      </div>
      <div class="navbar-right">
        <div class="search-box">
          <input type="text" placeholder="Search tasks, projects..." id="globalSearch">
          <i class="fas fa-search"></i>
        </div>
        <div class="notification-bell" onclick="openNotifications()">
          <i class="fas fa-bell fa-lg"></i>
          <span class="notification-badge" id="notifCount">3</span>
        </div>
        <div class="user-avatar" onclick="openUserMenu()">
          <i class="fas fa-user"></i>
        </div>
      </div>
    </nav>

    <!-- Content Area -->
    <div class="content-area" id="contentArea">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-tasks"></i> <span id="taskModalTitle">New Task</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="taskForm">
            <input type="hidden" id="taskId">
            
            <div class="mb-3">
              <label class="form-label">Task Title *</label>
              <input type="text" class="form-control" id="taskTitle" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="taskDescription" rows="3"></textarea>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Project</label>
                <select class="form-select" id="taskProject">
                  <option value="">No Project</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="taskStatus">
                  <option value="1">To Do</option>
                  <option value="2">In Progress</option>
                  <option value="3">Review</option>
                  <option value="4">Done</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" id="taskPriority">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Assignee</label>
                <input type="text" class="form-control" id="taskAssignee" placeholder="Enter name">
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="taskStartDate">
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-control" id="taskDueDate">
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Estimated Hours</label>
                <input type="number" class="form-control" id="taskEstimatedHours" step="0.5" placeholder="e.g., 4">
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Parent Task (Subtask of)</label>
                <select class="form-select" id="taskParent">
                  <option value="">None (Main Task)</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Tags</label>
              <input type="text" class="form-control" id="taskTags" placeholder="e.g., bug, frontend, urgent (comma separated)">
            </div>

            <!-- Time Tracker -->
            <div class="time-tracker">
              <div class="timer-display" id="timerDisplay">00:00:00</div>
              <div class="timer-controls">
                <button type="button" class="btn btn-success btn-sm" id="startTimer">
                  <i class="fas fa-play"></i> Start
                </button>
                <button type="button" class="btn btn-danger btn-sm" id="stopTimer" style="display: none;">
                  <i class="fas fa-stop"></i> Stop
                </button>
              </div>
              <small class="text-muted">Track time spent on this task</small>
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
              <h6><i class="fas fa-comments"></i> Comments</h6>
              <div id="commentsList">
                <!-- Comments will be loaded here -->
              </div>
              <div class="mt-3">
                <textarea class="form-control" id="newComment" rows="2" placeholder="Add a comment... (use @name to mention)"></textarea>
                <button type="button" class="btn btn-sm btn-primary mt-2" onclick="addComment()">
                  <i class="fas fa-paper-plane"></i> Post Comment
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveTask()">
            <i class="fas fa-save"></i> Save Task
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-folder-plus"></i> New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="projectForm">
            <div class="mb-3">
              <label class="form-label">Project Name *</label>
              <input type="text" class="form-control" id="projectName" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="projectDescription" rows="3"></textarea>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Color</label>
                <input type="color" class="form-control" id="projectColor" value="#3498db">
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Icon</label>
                <input type="text" class="form-control" id="projectIcon" value="📁" placeholder="📁">
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="projectStartDate">
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="projectEndDate">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveProject()">
            <i class="fas fa-save"></i> Create Project
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const SUPABASE_URL = 'https://mktkdxveeqpaxsxoblxb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rdGtkeHZlZXFwYXhzeG9ibHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDUwOTAsImV4cCI6MjA3NjEyMTA5MH0.uZunEWR8tjCwS3YSNk61kC37basm0RLkuGt8R17qnvw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========================================
    // GLOBAL STATE
    // ========================================
    let currentView = 'dashboard';
    let currentUser = null;
    let projects = [];
    let tasks = [];
    let statusWorkflows = [];
    let currentProjectFilter = null;
    let timerInterval = null;
    let timerSeconds = 0;

    // ========================================
    // INITIALIZATION
    // ========================================
    $(document).ready(async function() {
      // Check authentication
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        // For demo purposes, create a mock user
        currentUser = { id: 'demo-user', email: 'demo@taskpro.com' };
        console.log('Demo mode: No authentication required');
      } else {
        currentUser = user;
      }

      // Load initial data
      await loadProjects();
      await loadStatusWorkflows();
      await loadTasks();
      
      // Render dashboard
      renderView('dashboard');

      // Setup event listeners
      setupEventListeners();
    });

    // ========================================
    // EVENT LISTENERS
    // ========================================
    function setupEventListeners() {
      // Menu items click
      $('.menu-item').on('click', function() {
        const view = $(this).data('view');
        $('.menu-item').removeClass('active');
        $(this).addClass('active');
        renderView(view);
      });

      // Global search
      $('#globalSearch').on('keyup', function() {
        const query = $(this).val().toLowerCase();
        searchTasks(query);
      });

      // Timer controls
      $('#startTimer').on('click', startTimer);
      $('#stopTimer').on('click', stopTimer);
    }

    // ========================================
    // SIDEBAR FUNCTIONS
    // ========================================
    function toggleSidebar() {
      $('#sidebar').toggleClass('collapsed');
      $('#mainWrapper').toggleClass('expanded');
    }

    // ========================================
    // DATA LOADING
    // ========================================
    async function loadProjects() {
      const { data, error } = await supabase
        .from('projects')
        .select('*')
        .eq('status', 'active')
        .order('created_at', { ascending: false });
      
      if (!error && data) {
        projects = data;
        renderProjects();
        updateProjectSelects();
      }
    }

    async function loadStatusWorkflows() {
      // For demo, use hardcoded statuses
      statusWorkflows = [
        { id: 1, name: 'To Do', color: '#95a5a6', is_closed: false },
        { id: 2, name: 'In Progress', color: '#3498db', is_closed: false },
        { id: 3, name: 'Review', color: '#f39c12', is_closed: false },
        { id: 4, name: 'Done', color: '#27ae60', is_closed: true }
      ];
    }

    async function loadTasks() {
      let query = supabase
        .from('tasks')
        .select('*')
        .is('parent_task_id', null); // Only load main tasks
      
      if (currentProjectFilter) {
        query = query.eq('project_id', currentProjectFilter);
      }
      
      const { data, error } = await supabase
        .from('tasks')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (!error && data) {
        tasks = data;
      } else {
        // Demo data if no connection
        tasks = generateDemoTasks();
      }
    }

    // ========================================
    // RENDERING FUNCTIONS
    // ========================================
    function renderProjects() {
      const html = projects.map(p => `
        <div class="project-item" onclick="filterByProject(${p.id})">
          <div class="project-color" style="background: ${p.color}"></div>
          <span class="project-name">${p.icon || '📁'} ${p.name}</span>
        </div>
      `).join('');
      
      $('#projectList').html(html || '<div style="padding: 10px; text-align: center; color: rgba(255,255,255,0.5); font-size: 12px;">No projects yet</div>');
    }

    function updateProjectSelects() {
      const options = '<option value="">No Project</option>' + 
        projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      $('#taskProject').html(options);
    }

    function renderView(view) {
      currentView = view;
      $('#pageTitle').text(view.charAt(0).toUpperCase() + view.slice(1));
      
      switch(view) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'board':
          renderBoard();
          break;
        case 'list':
          renderList();
          break;
        case 'calendar':
          renderCalendar();
          break;
        case 'gantt':
          renderGantt();
          break;
        case 'team':
          renderTeam();
          break;
        case 'reports':
          renderReports();
          break;
        case 'settings':
          renderSettings();
          break;
      }
    }

    function renderDashboard() {
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(t => t.status_id === 4).length;
      const inProgressTasks = tasks.filter(t => t.status_id === 2).length;
      const overdueTasks = tasks.filter(t => t.due_date && new Date(t.due_date) < new Date() && t.status_id !== 4).length;
      
      const html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Total Tasks</div>
              <div class="stat-icon" style="background: #e3f2fd; color: #2196f3;">
                <i class="fas fa-tasks"></i>
              </div>
            </div>
            <div class="stat-number">${totalTasks}</div>
            <div class="stat-trend trend-up">
              <i class="fas fa-arrow-up"></i> ${Math.floor(Math.random() * 10) + 5}% from last week
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Completed</div>
              <div class="stat-icon" style="background: #e8f5e9; color: #4caf50;">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="stat-number">${completedTasks}</div>
            <div class="stat-trend">${Math.round(completedTasks/totalTasks*100) || 0}% completion rate</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">In Progress</div>
              <div class="stat-icon" style="background: #fff3e0; color: #ff9800;">
                <i class="fas fa-spinner"></i>
              </div>
            </div>
            <div class="stat-number">${inProgressTasks}</div>
            <div class="stat-trend">Active tasks</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Overdue</div>
              <div class="stat-icon" style="background: #ffebee; color: #f44336;">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
            </div>
            <div class="stat-number">${overdueTasks}</div>
            <div class="stat-trend trend-down">
              <i class="fas fa-arrow-down"></i> Needs attention
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-list-check"></i> Recent Tasks</h5>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Task</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Due Date</th>
                        <th>Assignee</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${tasks.slice(0, 10).map(t => {
                        const status = statusWorkflows.find(s => s.id === t.status_id);
                        return `
                          <tr onclick="editTask(${t.id})" style="cursor: pointer;">
                            <td><strong>${t.title}</strong></td>
                            <td><span class="badge" style="background: ${status?.color || '#95a5a6'}">${status?.name || 'Unknown'}</span></td>
                            <td><span class="task-priority priority-${t.priority}">${t.priority}</span></td>
                            <td>${t.due_date ? new Date(t.due_date).toLocaleDateString() : '-'}</td>
                            <td>${t.assignee || '-'}</td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Task Distribution</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-2">
                    <span>To Do</span>
                    <span><strong>${tasks.filter(t => t.status_id === 1).length}</strong></span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar" style="width: ${tasks.filter(t => t.status_id === 1).length / totalTasks * 100}%; background: #95a5a6;"></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-2">
                    <span>In Progress</span>
                    <span><strong>${inProgressTasks}</strong></span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar" style="width: ${inProgressTasks / totalTasks * 100}%; background: #3498db;"></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Review</span>
                    <span><strong>${tasks.filter(t => t.status_id === 3).length}</strong></span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar" style="width: ${tasks.filter(t => t.status_id === 3).length / totalTasks * 100}%; background: #f39c12;"></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Done</span>
                    <span><strong>${completedTasks}</strong></span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: ${completedTasks / totalTasks * 100}%;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderBoard() {
      const html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="fas fa-columns"></i> Kanban Board</h5>
          <button class="btn btn-primary" onclick="openTaskModal()">
            <i class="fas fa-plus"></i> New Task
          </button>
        </div>
        
        <div class="board-container">
          ${statusWorkflows.map(status => {
            const statusTasks = tasks.filter(t => t.status_id === status.id);
            return `
              <div class="board-column">
                <div class="column-header">
                  <div class="column-title">
                    <i class="fas fa-circle" style="color: ${status.color}; font-size: 10px;"></i>
                    ${status.name}
                  </div>
                  <span class="task-count-badge">${statusTasks.length}</span>
                </div>
                <div class="tasks-container">
                  ${statusTasks.map(t => renderTaskCard(t)).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderTaskCard(task) {
      const project = projects.find(p => p.id === task.project_id);
      return `
        <div class="task-card" onclick="editTask(${task.id})">
          <div class="task-card-header">
            <span class="task-priority priority-${task.priority}">${task.priority}</span>
          </div>
          <div class="task-title">${task.title}</div>
          ${task.description ? `<div class="text-muted small">${task.description.substring(0, 80)}...</div>` : ''}
          <div class="task-meta">
            ${task.due_date ? `<div class="task-meta-item"><i class="far fa-calendar"></i> ${new Date(task.due_date).toLocaleDateString()}</div>` : ''}
            ${task.estimated_hours ? `<div class="task-meta-item"><i class="far fa-clock"></i> ${task.estimated_hours}h</div>` : ''}
            ${project ? `<div class="task-meta-item"><i class="fas fa-folder" style="color: ${project.color}"></i> ${project.name}</div>` : ''}
          </div>
          ${task.tags && task.tags.length ? `
            <div class="task-tags">
              ${task.tags.map(tag => `<span class="task-tag">${tag}</span>`).join('')}
            </div>
          ` : ''}
          ${task.assignee ? `
            <div class="task-assignees">
              <div class="assignee-avatar">${task.assignee.charAt(0).toUpperCase()}</div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderList() {
      const html = `
        <div class="table-wrapper">
          <div class="table-filters">
            <div class="filter-group">
              <input type="text" class="form-control" placeholder="Search tasks..." id="listSearch">
            </div>
            <div class="filter-group">
              <select class="form-select" id="filterStatus" onchange="filterTasks()">
                <option value="">All Status</option>
                ${statusWorkflows.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
              </select>
            </div>
            <div class="filter-group">
              <select class="form-select" id="filterPriority" onchange="filterTasks()">
                <option value="">All Priority</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="openTaskModal()">
              <i class="fas fa-plus"></i> New Task
            </button>
          </div>
          
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="40"><input type="checkbox" onclick="toggleAllTasks()"></th>
                <th>Task</th>
                <th>Project</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Assignee</th>
                <th>Due Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${tasks.map(t => {
                const status = statusWorkflows.find(s => s.id === t.status_id);
                const project = projects.find(p => p.id === t.project_id);
                return `
                  <tr>
                    <td><input type="checkbox" value="${t.id}"></td>
                    <td onclick="editTask(${t.id})" style="cursor: pointer;">
                      <strong>${t.title}</strong>
                      ${t.description ? `<br><small class="text-muted">${t.description.substring(0, 60)}...</small>` : ''}
                    </td>
                    <td>${project ? `<span style="color: ${project.color}"><i class="fas fa-folder"></i> ${project.name}</span>` : '-'}</td>
                    <td><span class="badge" style="background: ${status?.color || '#95a5a6'}">${status?.name || 'Unknown'}</span></td>
                    <td><span class="task-priority priority-${t.priority}">${t.priority}</span></td>
                    <td>${t.assignee || '-'}</td>
                    <td>${t.due_date ? new Date(t.due_date).toLocaleDateString() : '-'}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" onclick="editTask(${t.id})">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.id})">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderCalendar() {
      const html = `
        <div class="calendar-container">
          <div class="calendar-header">
            <h4><i class="far fa-calendar-alt"></i> ${new Date().toLocaleString('default', { month: 'long', year: 'numeric' })}</h4>
            <div class="calendar-nav">
              <button class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
              <button class="btn btn-outline-secondary btn-sm">Today</button>
              <button class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>
          <div class="calendar-grid">
            ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
              `<div class="calendar-day-header">${day}</div>`
            ).join('')}
            ${Array.from({length: 35}, (_, i) => {
              const day = i - 3; // Adjust for month start
              return `
                <div class="calendar-day">
                  <div class="calendar-day-number">${day > 0 && day <= 31 ? day : ''}</div>
                  ${day > 0 && day <= 31 ? `
                    ${tasks.filter(t => t.due_date && new Date(t.due_date).getDate() === day)
                      .slice(0, 3)
                      .map(t => `<div class="calendar-task" onclick="editTask(${t.id})">${t.title}</div>`)
                      .join('')}
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderGantt() {
      const html = `
        <div class="gantt-container">
          <h5 class="mb-4"><i class="fas fa-chart-bar"></i> Project Timeline</h5>
          <div class="text-center text-muted py-5">
            <i class="fas fa-chart-gantt fa-4x mb-3 opacity-25"></i>
            <h5>Gantt Chart View</h5>
            <p>Interactive timeline view coming soon...</p>
            <small>This will show task dependencies, duration, and progress</small>
          </div>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderTeam() {
      const html = `
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users"></i> Team Members</h5>
                <button class="btn btn-primary btn-sm"><i class="fas fa-user-plus"></i> Invite Member</button>
              </div>
              <div class="card-body">
                <div class="text-center text-muted py-5">
                  <i class="fas fa-users fa-4x mb-3 opacity-25"></i>
                  <h5>Team Management</h5>
                  <p>Manage team members, roles, and permissions</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-user-shield"></i> Roles</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <strong>Admin</strong>
                  <p class="small text-muted mb-0">Full access to all features</p>
                </div>
                <div class="mb-3">
                  <strong>Manager</strong>
                  <p class="small text-muted mb-0">Manage projects and tasks</p>
                </div>
                <div class="mb-3">
                  <strong>Member</strong>
                  <p class="small text-muted mb-0">Create and edit tasks</p>
                </div>
                <div class="mb-3">
                  <strong>Viewer</strong>
                  <p class="small text-muted mb-0">Read-only access</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderReports() {
      const html = `
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Analytics & Reports</h5>
              </div>
              <div class="card-body">
                <div class="text-center text-muted py-5">
                  <i class="fas fa-chart-line fa-4x mb-3 opacity-25"></i>
                  <h5>Advanced Analytics</h5>
                  <p>Detailed reports, performance metrics, and insights</p>
                  <ul class="list-unstyled mt-4">
                    <li>• Task completion trends</li>
                    <li>• Team productivity metrics</li>
                    <li>• Project progress tracking</li>
                    <li>• Time tracking analytics</li>
                    <li>• Custom report builder</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    function renderSettings() {
      const html = `
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-cog"></i> Settings</h5>
          </div>
          <div class="card-body">
            <div class="text-center text-muted py-5">
              <i class="fas fa-cog fa-4x mb-3 opacity-25"></i>
              <h5>Application Settings</h5>
              <p>Configure your workspace, notifications, integrations, and more</p>
            </div>
          </div>
        </div>
      `;
      
      $('#contentArea').html(html);
    }

    // ========================================
    // TASK FUNCTIONS
    // ========================================
    function openTaskModal() {
      $('#taskId').val('');
      $('#taskForm')[0].reset();
      $('#taskModalTitle').text('New Task');
      $('#taskModal').modal('show');
    }

    async function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      $('#taskId').val(task.id);
      $('#taskTitle').val(task.title);
      $('#taskDescription').val(task.description || '');
      $('#taskProject').val(task.project_id || '');
      $('#taskStatus').val(task.status_id);
      $('#taskPriority').val(task.priority);
      $('#taskAssignee').val(task.assignee || '');
      $('#taskStartDate').val(task.start_date || '');
      $('#taskDueDate').val(task.due_date || '');
      $('#taskEstimatedHours').val(task.estimated_hours || '');
      $('#taskParent').val(task.parent_task_id || '');
      $('#taskTags').val(task.tags ? task.tags.join(', ') : '');
      
      $('#taskModalTitle').text('Edit Task');
      $('#taskModal').modal('show');
      
      // Load comments
      loadComments(taskId);
    }

    async function saveTask() {
      const taskId = $('#taskId').val();
      const taskData = {
        title: $('#taskTitle').val(),
        description: $('#taskDescription').val(),
        project_id: $('#taskProject').val() || null,
        status_id: parseInt($('#taskStatus').val()),
        priority: $('#taskPriority').val(),
        assignee: $('#taskAssignee').val() || null,
        start_date: $('#taskStartDate').val() || null,
        due_date: $('#taskDueDate').val() || null,
        estimated_hours: $('#taskEstimatedHours').val() || null,
        parent_task_id: $('#taskParent').val() || null,
        tags: $('#taskTags').val() ? $('#taskTags').val().split(',').map(t => t.trim()) : [],
        updated_at: new Date().toISOString()
      };

      if (taskId) {
        // Update existing task
        const { error } = await supabase
          .from('tasks')
          .update(taskData)
          .eq('id', taskId);
        
        if (error) {
          alert('Error updating task: ' + error.message);
          return;
        }
      } else {
        // Create new task
        // taskData.creator_id = currentUser?.id || 'demo-user';
        taskData.created_at = new Date().toISOString();
        
        const { error } = await supabase
          .from('tasks').insert([taskData]);
        if (error) {
          alert('Error creating task: ' + error.message);
          return;
        }
      }

      $('#taskModal').modal('hide');
      await loadTasks();
      renderView(currentView);
    }

    async function deleteTask(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      const { error } = await supabase
        .from('tasks')
        .delete()
        .eq('id', taskId);
      
      if (!error) {
        await loadTasks();
        renderView(currentView);
      } else {
        alert('Error deleting task: ' + error.message);
      }
    }

    // ========================================
    // PROJECT FUNCTIONS
    // ========================================
    function openProjectModal() {
      $('#projectForm')[0].reset();
      $('#projectModal').modal('show');
    }

    async function saveProject() {
      const projectData = {
        name: $('#projectName').val(),
        description: $('#projectDescription').val(),
        color: $('#projectColor').val(),
        icon: $('#projectIcon').val(),
        start_date: $('#projectStartDate').val() || null,
        end_date: $('#projectEndDate').val() || null,
        // owner_id: currentUser?.id || 'demo-user',
        status: 'active',
        created_at: new Date().toISOString()
      };

      const { error } = await supabase
        .from('projects')
        .insert([projectData]);
      
      if (!error) {
        $('#projectModal').modal('hide');
        await loadProjects();
      } else {
        alert('Error creating project: ' + error.message);
      }
    }

    function filterByProject(projectId) {
      currentProjectFilter = projectId;
      loadTasks();
    }

    // ========================================
    // COMMENT FUNCTIONS
    // ========================================
    async function loadComments(taskId) {
      const { data, error } = await supabase
        .from('comments')
        .select('*')
        .eq('task_id', taskId)
        .order('created_at', { ascending: true });
      
      if (!error && data) {
        renderComments(data);
      } else {
        $('#commentsList').html('<p class="text-muted small">No comments yet</p>');
      }
    }

    function renderComments(comments) {
      const html = comments.map(c => `
        <div class="comment-item">
          <div class="comment-avatar">${c.author ? c.author.charAt(0).toUpperCase() : 'U'}</div>
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-author">${c.author || 'Anonymous'}</span>
              <span class="comment-time">${formatTimeAgo(c.created_at)}</span>
            </div>
            <div class="comment-text">${c.content}</div>
          </div>
        </div>
      `).join('');
      
      $('#commentsList').html(html || '<p class="text-muted small">No comments yet</p>');
    }

    async function addComment() {
      const taskId = $('#taskId').val();
      if (!taskId) return;
      
      const content = $('#newComment').val().trim();
      if (!content) return;
      
      const commentData = {
        task_id: parseInt(taskId),
        user_id: currentUser?.id || 'demo-user',
        author: currentUser?.email || 'Demo User',
        content: content,
        created_at: new Date().toISOString()
      };
      
      const { error } = await supabase
        .from('comments')
        .insert([commentData]);
      
      if (!error) {
        $('#newComment').val('');
        await loadComments(taskId);
      } else {
        alert('Error adding comment: ' + error.message);
      }
    }

    // ========================================
    // TIME TRACKING
    // ========================================
    function startTimer() {
      timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
      }, 1000);
      
      $('#startTimer').hide();
      $('#stopTimer').show();
    }

    function stopTimer() {
      clearInterval(timerInterval);
      
      // Save time entry
      const taskId = $('#taskId').val();
      if (taskId && timerSeconds > 0) {
        saveTimeEntry(taskId, timerSeconds);
      }
      
      timerSeconds = 0;
      updateTimerDisplay();
      
      $('#startTimer').show();
      $('#stopTimer').hide();
    }

    function updateTimerDisplay() {
      const hours = Math.floor(timerSeconds / 3600);
      const minutes = Math.floor((timerSeconds % 3600) / 60);
      const seconds = timerSeconds % 60;
      
      const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      $('#timerDisplay').text(display);
    }

    async function saveTimeEntry(taskId, durationSeconds) {
      const timeData = {
        task_id: parseInt(taskId),
        user_id: currentUser?.id || 'demo-user',
        start_time: new Date(Date.now() - durationSeconds * 1000).toISOString(),
        end_time: new Date().toISOString(),
        duration_seconds: durationSeconds,
        is_running: false,
        created_at: new Date().toISOString()
      };
      
      const { error } = await supabase
        .from('time_entries')
        .insert([timeData]);
      
      if (error) {
        console.error('Error saving time entry:', error);
      }
    }

    // ========================================
    // SEARCH & FILTER
    // ========================================
    function searchTasks(query) {
      if (!query) {
        renderView(currentView);
        return;
      }
      
      const filtered = tasks.filter(t => 
        t.title.toLowerCase().includes(query) ||
        (t.description && t.description.toLowerCase().includes(query)) ||
        (t.assignee && t.assignee.toLowerCase().includes(query))
      );
      
      // Update view with filtered tasks
      if (currentView === 'board') {
        renderBoardWithTasks(filtered);
      } else if (currentView === 'list') {
        renderListWithTasks(filtered);
      }
    }

    function filterTasks() {
      const statusFilter = $('#filterStatus').val();
      const priorityFilter = $('#filterPriority').val();
      
      let filtered = [...tasks];
      
      if (statusFilter) {
        filtered = filtered.filter(t => t.status_id == statusFilter);
      }
      
      if (priorityFilter) {
        filtered = filtered.filter(t => t.priority === priorityFilter);
      }
      
      renderListWithTasks(filtered);
    }

    function renderListWithTasks(taskList) {
      const tbody = taskList.map(t => {
        const status = statusWorkflows.find(s => s.id === t.status_id);
        const project = projects.find(p => p.id === t.project_id);
        return `
          <tr>
            <td><input type="checkbox" value="${t.id}"></td>
            <td onclick="editTask(${t.id})" style="cursor: pointer;">
              <strong>${t.title}</strong>
              ${t.description ? `<br><small class="text-muted">${t.description.substring(0, 60)}...</small>` : ''}
            </td>
            <td>${project ? `<span style="color: ${project.color}"><i class="fas fa-folder"></i> ${project.name}</span>` : '-'}</td>
            <td><span class="badge" style="background: ${status?.color || '#95a5a6'}">${status?.name || 'Unknown'}</span></td>
            <td><span class="task-priority priority-${t.priority}">${t.priority}</span></td>
            <td>${t.assignee || '-'}</td>
            <td>${t.due_date ? new Date(t.due_date).toLocaleDateString() : '-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editTask(${t.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      $('tbody').html(tbody);
    }

    function renderBoardWithTasks(taskList) {
      statusWorkflows.forEach(status => {
        const statusTasks = taskList.filter(t => t.status_id === status.id);
        const column = $(`.board-column:eq(${statusWorkflows.indexOf(status)})`);
        const html = statusTasks.map(t => renderTaskCard(t)).join('');
        column.find('.tasks-container').html(html);
        column.find('.task-count-badge').text(statusTasks.length);
      });
    }

    function toggleAllTasks() {
      const checked = event.target.checked;
      $('tbody input[type="checkbox"]').prop('checked', checked);
    }

    // ========================================
    // NOTIFICATIONS
    // ========================================
    function openNotifications() {
      alert('Notifications panel coming soon!\n\nYou will see:\n• Task assignments\n• Due date reminders\n• @mentions\n• Status changes\n• Comments');
    }

    // ========================================
    // USER MENU
    // ========================================
    function openUserMenu() {
      alert('User menu coming soon!\n\nOptions:\n• Profile Settings\n• Preferences\n• Keyboard Shortcuts\n• Help & Support\n• Logout');
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function formatTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
      
      return date.toLocaleDateString();
    }

    function generateDemoTasks() {
      // Demo data for testing without database
      return [
        {
          id: 1,
          title: 'Design new landing page',
          description: 'Create mockups for the new marketing landing page with modern design',
          project_id: null,
          status_id: 1,
          priority: 'high',
          assignee: 'John Doe',
          due_date: '2025-10-20',
          start_date: '2025-10-15',
          estimated_hours: 8,
          tags: ['design', 'ui'],
          created_at: '2025-10-10T10:00:00Z'
        },
        {
          id: 2,
          title: 'Implement user authentication',
          description: 'Add JWT-based authentication with email/password and social login',
          project_id: null,
          status_id: 2,
          priority: 'urgent',
          assignee: 'Jane Smith',
          due_date: '2025-10-18',
          start_date: '2025-10-12',
          estimated_hours: 16,
          tags: ['backend', 'security'],
          created_at: '2025-10-09T14:30:00Z'
        },
        {
          id: 3,
          title: 'Write API documentation',
          description: 'Document all REST API endpoints with examples and parameters',
          project_id: null,
          status_id: 3,
          priority: 'medium',
          assignee: 'Bob Johnson',
          due_date: '2025-10-22',
          start_date: '2025-10-14',
          estimated_hours: 6,
          tags: ['documentation'],
          created_at: '2025-10-08T09:15:00Z'
        },
        {
          id: 4,
          title: 'Fix mobile responsive issues',
          description: 'Address layout problems on mobile devices, especially iOS Safari',
          project_id: null,
          status_id: 1,
          priority: 'high',
          assignee: 'Alice Brown',
          due_date: '2025-10-19',
          start_date: '2025-10-16',
          estimated_hours: 4,
          tags: ['bug', 'frontend'],
          created_at: '2025-10-11T11:45:00Z'
        },
        {
          id: 5,
          title: 'Database optimization',
          description: 'Optimize slow queries and add missing indexes',
          project_id: null,
          status_id: 2,
          priority: 'medium',
          assignee: 'Charlie Wilson',
          due_date: '2025-10-25',
          start_date: '2025-10-13',
          estimated_hours: 12,
          tags: ['database', 'performance'],
          created_at: '2025-10-07T16:20:00Z'
        },
        {
          id: 6,
          title: 'Setup CI/CD pipeline',
          description: 'Configure automated testing and deployment with GitHub Actions',
          project_id: null,
          status_id: 4,
          priority: 'medium',
          assignee: 'David Lee',
          due_date: '2025-10-15',
          start_date: '2025-10-01',
          estimated_hours: 8,
          tags: ['devops'],
          created_at: '2025-10-05T13:00:00Z'
        },
        {
          id: 7,
          title: 'User testing session',
          description: 'Conduct usability testing with 10 users and gather feedback',
          project_id: null,
          status_id: 1,
          priority: 'low',
          assignee: 'Eve Martinez',
          due_date: '2025-10-28',
          start_date: '2025-10-20',
          estimated_hours: 10,
          tags: ['ux', 'research'],
          created_at: '2025-10-12T08:30:00Z'
        },
        {
          id: 8,
          title: 'Implement dark mode',
          description: 'Add dark theme toggle with system preference detection',
          project_id: null,
          status_id: 2,
          priority: 'low',
          assignee: 'Frank Garcia',
          due_date: '2025-10-30',
          start_date: '2025-10-17',
          estimated_hours: 6,
          tags: ['frontend', 'feature'],
          created_at: '2025-10-06T15:45:00Z'
        },
        {
          id: 9,
          title: 'Security audit',
          description: 'Perform comprehensive security review and fix vulnerabilities',
          project_id: null,
          status_id: 3,
          priority: 'urgent',
          assignee: 'Grace Chen',
          due_date: '2025-10-21',
          start_date: '2025-10-10',
          estimated_hours: 20,
          tags: ['security'],
          created_at: '2025-10-04T12:00:00Z'
        },
        {
          id: 10,
          title: 'Email notification system',
          description: 'Build email templates and notification logic for all events',
          project_id: null,
          status_id: 1,
          priority: 'medium',
          assignee: 'Henry Kim',
          due_date: '2025-10-26',
          start_date: '2025-10-18',
          estimated_hours: 14,
          tags: ['backend', 'feature'],
          created_at: '2025-10-13T10:30:00Z'
        }
      ];
    }

    // ========================================
    // KEYBOARD SHORTCUTS
    // ========================================
    $(document).on('keydown', function(e) {
      // Ctrl/Cmd + K for search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        $('#globalSearch').focus();
      }
      
      // Ctrl/Cmd + N for new task
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        openTaskModal();
      }
      
      // ESC to close modals
      if (e.key === 'Escape') {
        $('.modal').modal('hide');
      }
    });

    // ========================================
    // DRAG & DROP (Basic Implementation)
    // ========================================
    // This is a placeholder for drag & drop functionality
    // In production, you would use a library like SortableJS
    
    function enableDragDrop() {
      $('.task-card').attr('draggable', true);
      
      $('.task-card').on('dragstart', function(e) {
        e.originalEvent.dataTransfer.setData('text/plain', $(this).data('task-id'));
        $(this).addClass('dragging');
      });
      
      $('.task-card').on('dragend', function() {
        $(this).removeClass('dragging');
      });
      
      $('.board-column').on('dragover', function(e) {
        e.preventDefault();
      });
      
      $('.board-column').on('drop', function(e) {
        e.preventDefault();
        const taskId = e.originalEvent.dataTransfer.getData('text/plain');
        const newStatusId = $(this).data('status-id');
        
        // Update task status
        updateTaskStatus(taskId, newStatusId);
      });
    }

    async function updateTaskStatus(taskId, statusId) {
      const { error } = await supabase
        .from('tasks')
        .update({ 
          status_id: statusId,
          updated_at: new Date().toISOString()
        })
        .eq('id', taskId);
      
      if (!error) {
        await loadTasks();
        renderView('board');
      }
    }

    // ========================================
    // RECURRING TASKS
    // ========================================
    async function createRecurringTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task || !task.is_recurring) return;
      
      // Logic to create next occurrence based on recurrence_pattern
      const pattern = task.recurrence_pattern;
      // Implement recurrence logic here
    }

    // ========================================
    // TASK DEPENDENCIES
    // ========================================
    async function checkDependencies(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task || !task.depends_on || task.depends_on.length === 0) return true;
      
      // Check if all dependent tasks are completed
      const dependencies = tasks.filter(t => task.depends_on.includes(t.id));
      const allCompleted = dependencies.every(t => t.status_id === 4);
      
      if (!allCompleted) {
        alert('This task depends on other tasks that are not yet completed.');
        return false;
      }
      
      return true;
    }

    // ========================================
    // BULK OPERATIONS
    // ========================================
    function bulkUpdateTasks() {
      const selected = $('tbody input[type="checkbox"]:checked').map(function() {
        return $(this).val();
      }).get();
      
      if (selected.length === 0) {
        alert('Please select tasks to update');
        return;
      }
      
      // Show bulk update modal
      alert(`Bulk update for ${selected.length} tasks\n\nOptions:\n• Change status\n• Change priority\n• Assign to user\n• Add tags\n• Delete`);
    }

    // ========================================
    // EXPORT / IMPORT
    // ========================================
    function exportTasks() {
      const csv = convertTasksToCSV(tasks);
      downloadCSV(csv, 'tasks-export.csv');
    }

    function convertTasksToCSV(tasks) {
      const headers = ['ID', 'Title', 'Description', 'Status', 'Priority', 'Assignee', 'Due Date', 'Created'];
      const rows = tasks.map(t => [
        t.id,
        t.title,
        t.description || '',
        statusWorkflows.find(s => s.id === t.status_id)?.name || '',
        t.priority,
        t.assignee || '',
        t.due_date || '',
        t.created_at
      ]);
      
      return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // ========================================
    // TEMPLATES
    // ========================================
    async function saveAsTemplate() {
      const taskId = $('#taskId').val();
      if (!taskId) return;
      
      const task = tasks.find(t => t.id === taskId);
      const templateName = prompt('Enter template name:');
      
      if (!templateName) return;
      
      const templateData = {
        name: templateName,
        project_id: task.project_id,
        template_data: {
          title: task.title,
          description: task.description,
          priority: task.priority,
          estimated_hours: task.estimated_hours,
          tags: task.tags
        },
        created_at: new Date().toISOString()
      };
      
      const { error } = await supabase
        .from('task_templates')
        .insert([templateData]);
      
      if (!error) {
        alert('Template saved successfully!');
      }
    }

    // ========================================
    // AUTOMATIONS
    // ========================================
    async function runAutomations(taskId, trigger) {
      const { data: automations } = await supabase
        .from('automations')
        .select('*')
        .eq('is_active', true);
      
      if (!automations) return;
      
      for (const automation of automations) {
        if (automation.trigger.type === trigger) {
          // Execute automation actions
          for (const action of automation.actions) {
            await executeAutomationAction(taskId, action);
          }
        }
      }
    }

    async function executeAutomationAction(taskId, action) {
      switch (action.type) {
        case 'assign':
          await supabase
            .from('tasks')
            .update({ assignee: action.user_id })
            .eq('id', taskId);
          break;
        case 'move_to_status':
          await supabase
            .from('tasks')
            .update({ status_id: action.status_id })
            .eq('id', taskId);
          break;
        case 'add_comment':
          await supabase
            .from('comments')
            .insert([{
              task_id: taskId,
              content: action.comment,
              author: 'Automation Bot'
            }]);
          break;
      }
    }

    // ========================================
    // CONSOLE HELPERS
    // ========================================
    console.log('%c🚀 TaskPro Loaded Successfully!', 'color: #3498db; font-size: 16px; font-weight: bold;');
    console.log('%cKeyboard Shortcuts:', 'color: #27ae60; font-weight: bold;');
    console.log('• Ctrl/Cmd + K: Focus search');
    console.log('• Ctrl/Cmd + N: New task');
    console.log('• ESC: Close modals');
    console.log('\n%cGlobal Functions:', 'color: #e74c3c; font-weight: bold;');
    console.log('• openTaskModal() - Create new task');
    console.log('• openProjectModal() - Create new project');
    console.log('• exportTasks() - Export to CSV');
    console.log('• loadTasks() - Refresh tasks');
    console.log('• loadProjects() - Refresh projects');
  </script>
</body>
</html>